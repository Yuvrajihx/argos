'use strict';

var core = require('@argos-ci/core');
var node_path = require('node:path');
var promises = require('node:fs/promises');

/// <reference types="cypress" />
function registerArgosTask(on, config, options) {
    on("after:screenshot", async (details)=>{
        // Get the base filename without extension
        const baseName = node_path.basename(details.path, node_path.extname(details.path));
        // Remove attempt from the filename
        const newBaseName = baseName.replace(/ \(attempt \d+\)/, "");
        // Construct a new path with the original file extension
        const newPath = node_path.join(node_path.dirname(details.path), newBaseName + node_path.extname(details.path));
        // Rename the file
        await promises.rename(details.path, newPath);
        return {
            path: newPath
        };
    });
    on("after:run", async ()=>{
        const { screenshotsFolder } = config;
        if (!screenshotsFolder) return;
        const { uploadToArgos = true } = options || {};
        if (!uploadToArgos) return;
        const res = await core.upload({
            files: [
                "**/*.png"
            ],
            root: screenshotsFolder,
            ...options
        });
        console.log(`âœ… Argos build created: ${res.build.url}`);
    });
}

exports.registerArgosTask = registerArgosTask;
